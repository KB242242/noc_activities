// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// ==================== SQLITE CONFIGURATION ====================
// Uncomment the block below for SQLite (default for development)
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== MYSQL CONFIGURATION ====================
// Uncomment the block below for MySQL (WampServer production)
// Replace the connection string with your MySQL credentials
/*
datasource db {
  provider = "mysql"
  url      = "mysql://username:password@localhost:3306/noc_activity"
}
// Example: mysql://root:@localhost:3306/noc_activity
// For WampServer default: root with no password
*/

// User model with role-based access
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  firstName     String?
  lastName      String?
  role          Role     @default(AGENT)
  shiftId       String?
  avatar        String?
  isActive      Boolean  @default(true)
  lastActiveAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  shift         Shift?         @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  activities    Activity[]
  overtimes     Overtime[]
  responsibilities Responsibility[]
  individualRests IndividualRest[]
  dayAssignments DayAssignment[]
  tasks         Task[]
  handovers     Handover[]
  
  @@index([email])
  @@index([shiftId])
}

enum Role {
  ADMIN
  SUPERVISOR
  AGENT
}

// Shift model (A, B, C)
model Shift {
  id          String   @id @default(cuid())
  name        String   @unique // "A", "B", "C"
  color       String   // "blue", "yellow", "green"
  colorCode   String   // Hex color code
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  members     User[]
  cycles      ShiftCycle[]
  
  @@map("shifts")
}

// Shift Cycle - represents a work period (6 work days + 3 rest days)
model ShiftCycle {
  id            String   @id @default(cuid())
  shiftId       String
  startDate     DateTime
  endDate       DateTime
  cycleNumber   Int      // Sequential cycle number
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  shift         Shift         @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  workDays      WorkDay[]
  individualRests IndividualRest[]
  
  @@index([shiftId, startDate])
  @@index([shiftId, cycleNumber])
}

// Work Day - each day within a cycle
model WorkDay {
  id            String     @id @default(cuid())
  cycleId       String
  date          DateTime
  dayType       DayType
  startHour     Int        // 7 or 19
  endHour       Int        // 19 or 7
  dayNumber     Int        // 1-6 within the cycle (work days only)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  cycle         ShiftCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  assignments   DayAssignment[]
  
  @@unique([cycleId, date])
  @@index([cycleId])
  @@index([date])
}

enum DayType {
  DAY_SHIFT    // 07h-19h
  NIGHT_SHIFT  // 19h-07h
  REST_DAY     // Collective rest
}

// Day Assignment - who works on what role each day
model DayAssignment {
  id               String           @id @default(cuid())
  workDayId        String
  userId           String
  responsibility   ResponsibilityType?
  isResting        Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  workDay          WorkDay          @relation(fields: [workDayId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([workDayId, userId])
  @@index([workDayId])
  @@index([userId])
}

enum ResponsibilityType {
  CALL_CENTER
  MONITORING
  REPORTING_1
  REPORTING_2
}

// Individual Rest - rotating rest days
model IndividualRest {
  id          String   @id @default(cuid())
  cycleId     String
  userId      String
  restDay     Int      // Which day of the cycle (3, 4, 5, or 6)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  cycle       ShiftCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([cycleId, userId])
  @@index([cycleId])
  @@index([userId])
}

// Task - Daily tasks management
model Task {
  id              String     @id @default(cuid())
  userId          String
  title           String
  description     String?
  status          TaskStatus @default(pending)
  category        String     // "Monitoring", "Call Center", "Reporting 1", "Reporting 2"
  responsibility  ResponsibilityType?
  scheduledTime   String?    // "09:00", "12:00", etc.
  completedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([userId, status])
  @@index([category])
}

enum TaskStatus {
  pending
  in_progress
  completed
  on_hold
}

// Activity tracking
model Activity {
  id          String       @id @default(cuid())
  userId      String
  type        ActivityType
  category    String       // "Monitoring", "Call Center", "Reporting 1", "Reporting 2"
  description String
  metadata    String?      // JSON for additional data
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([category])
  @@index([type])
}

enum ActivityType {
  CLIENT_DOWN
  INTERFACE_UNSTABLE
  RECURRENT_PROBLEM
  EQUIPMENT_ALERT
  OTHER_MONITORING
  TICKET_CREATED
  CLIENT_CALL
  ESCALATION
  INCIDENT_FOLLOWUP
  CLIENT_INFO
  GRAPH_SENT
  ALERT_PUBLISHED
  HANDOVER_WRITTEN
  INCIDENT_HISTORY
  REPORT_GENERATED
  TICKET_UPDATED
  TICKET_CLOSED
  RFO_CREATED
  ARCHIVE_DONE
}

// Overtime tracking
model Overtime {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  duration    Int      @default(120) // Always 2 hours = 120 minutes
  shiftType   String   // "jour" or "nuit"
  startTime   String   // "07:00" or "18:00"
  endTime     String   // "08:00" or "19:00"
  reason      String   @default("Supervision NOC")
  approvedBy  String   @default("Daddy AZUMY")
  month       Int
  year        Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId, month, year])
  @@index([date])
}

// Responsibility history for rotation tracking
model Responsibility {
  id              String             @id @default(cuid())
  userId          String
  responsibility  ResponsibilityType
  startDate       DateTime
  endDate         DateTime?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, startDate])
}

// Handover reports
model Handover {
  id            String   @id @default(cuid())
  authorId      String
  shiftId       String
  date          DateTime
  content       String
  incidents     String?  // JSON array of incident IDs
  escalations   String?  // JSON array of escalation details
  pendingTasks  String?  // JSON array of pending task IDs
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  author        User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  @@index([authorId, date])
  @@index([shiftId, date])
}

// System settings
model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([key])
}

// External Links - Platform shortcuts
model ExternalLink {
  id          String   @id @default(cuid())
  name        String
  url         String
  category    String   // "monitoring", "tickets", "communication", "tracking"
  icon        String?  // Icon name
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([order])
}

// Graph Schedule - For Reporting 1
model GraphSchedule {
  id          String   @id @default(cuid())
  time        String   // "09:00", "12:00", "15:00", "18:00" for day shift
  shiftType   String   // "day" or "night"
  sent        Boolean  @default(false)
  sentAt      DateTime?
  sentBy      String?
  date        DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([date, shiftType])
  @@index([time])
}
